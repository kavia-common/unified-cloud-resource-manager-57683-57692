{"is_source_file": true, "format": "TypeScript", "description": "This is a serverless or edge function source code in TypeScript designed for automation enforcement in a cloud resource management context. It handles HTTP POST requests to trigger resource rules enforcement, fetches rules and resources from a database, applies filtering, enqueues operations, and logs activities.", "external_files": ["https://deno.land/std/http/server.ts"], "external_methods": ["serve", "json", "apiHeaders", "getUserIdFromJwt", "padB64", "writeActivity"], "published": ["serve"], "classes": [], "methods": [{"name": "function filterByRule(resources: any[], match: string): any[] { filterByRule", "description": "Filters resources based on a simple rule match string, supporting clauses like type, provider, region, and tags.", "scope": "", "scopeKind": ""}, {"name": "async function writeActivity(url: string, key: string, userId: string, row: Record<string, unkno/ writeActivity", "description": "Sends activity log entries to the external activity_log endpoint.", "scope": "", "scopeKind": ""}, {"name": "function json(body: unknown, status = 200) { json", "description": "Constructs an HTTP JSON response with specified status code.", "scope": "", "scopeKind": ""}, {"name": "function apiHeaders(key: string) { apiHeaders", "description": "Prepares headers for API authentication including api key and authorization.", "scope": "", "scopeKind": ""}, {"name": "function getUserIdFromJwt(token: string): string | null { getUserIdFromJwt", "description": "Extracts user ID (sub claim) from a JWT token.", "scope": "", "scopeKind": ""}, {"name": "function padB64(b: string) { padB64", "description": "Pads Base64 URL-safe encoded strings to proper padding for decoding.", "scope": "", "scopeKind": ""}], "calls": ["fetch", "getUserIdFromJwt", "writeActivity", "json"], "search-terms": ["automation-enforcer", "resource rules", "resource filtering", "enqueue operations", "automation rule execution", "edge function", "Supabase"], "state": 2, "file_id": 63, "knowledge_revision": 188, "git_revision": "", "ctags": [{"_type": "tag", "name": "SERVICE_KEY", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const SERVICE_KEY = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\") || Deno.env.get(\"SUPABASE_ANON/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "SUPABASE_URL", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const SUPABASE_URL = Deno.env.get(\"SUPABASE_URL\");$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "apiHeaders", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^function apiHeaders(key: string) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "authHeader", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const authHeader = req.headers.get(\"Authorization\") || \"\";$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "clauses", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^  const clauses = String(match)$/", "language": "TypeScript", "kind": "constant", "scope": "filterByRule", "scopeKind": "function"}, {"_type": "tag", "name": "errText", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^          const errText = await opsResp.text();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "filterByRule", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^function filterByRule(resources: any[], match: string): any[] {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "getUserIdFromJwt", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^function getUserIdFromJwt(token: string): string | null {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "inserted", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^          const inserted = await opsResp.json();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "json", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^function json(body: unknown, status = 200) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "jwt", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const jwt = authHeader.startsWith(\"Bearer \") ? authHeader.slice(7) : null;$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "k", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^      const [k, vRaw] = cl.split(\"=\").map((s) => s.trim());$/", "language": "TypeScript", "kind": "constant", "scope": "filterByRule", "scopeKind": "function"}, {"_type": "tag", "name": "matches", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^      const matches = filterByRule(resources, rule.match || \"\");$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "now", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const now = new Date().toISOString();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "opsPayload", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^      const opsPayload = matches.map((r: any) => ({$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "opsResp", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^        const opsResp = await fetch(`${SUPABASE_URL}\\/rest\\/v1\\/operations`, {$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "padB64", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^function padB64(b: string) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "parts", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const parts = token.split(\".\");$/", "language": "TypeScript", "kind": "constant", "scope": "getUserIdFromJwt", "scopeKind": "function"}, {"_type": "tag", "name": "payload", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const payload = JSON.parse(atob(padB64(parts[1])));$/", "language": "TypeScript", "kind": "constant", "scope": "getUserIdFromJwt", "scopeKind": "function"}, {"_type": "tag", "name": "queued", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^      let queued = 0;$/", "language": "TypeScript", "kind": "variable"}, {"_type": "tag", "name": "resResp", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const resResp = await fetch(`${SUPABASE_URL}\\/rest\\/v1\\/resources?user_id=eq.${userId}&selec/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "resources", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const resources: any[] = resResp.ok ? await resResp.json() : [];$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "rule", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    for (const rule of rules) {$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "rules", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const rules: any[] = await rulesResp.json();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "rulesResp", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const rulesResp = await fetch($/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "runRecords", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const runRecords: any[] = [];$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "t", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^      const t = await rulesResp.text();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "tagKey", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^        const tagKey = k.slice(5);$/", "language": "TypeScript", "kind": "constant", "scope": "filterByRule", "scopeKind": "function"}, {"_type": "tag", "name": "tagVal", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^        const tagVal = r?.tags?.[tagKey];$/", "language": "TypeScript", "kind": "constant", "scope": "filterByRule", "scopeKind": "function"}, {"_type": "tag", "name": "totalQueued", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    let totalQueued = 0;$/", "language": "TypeScript", "kind": "variable"}, {"_type": "tag", "name": "url", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const url = new URL(req.url);$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "userId", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^    const userId = getUserIdFromJwt(jwt || \"\");$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "v", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^      const v = (vRaw || \"\").replace(\\/^['\"]|['\"]$\\/g, \"\");$/", "language": "TypeScript", "kind": "constant", "scope": "filterByRule", "scopeKind": "function"}, {"_type": "tag", "name": "vRaw", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^      const [k, vRaw] = cl.split(\"=\").map((s) => s.trim());$/", "language": "TypeScript", "kind": "constant", "scope": "filterByRule", "scopeKind": "function"}, {"_type": "tag", "name": "val", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^      const val = r?.[k];$/", "language": "TypeScript", "kind": "constant", "scope": "filterByRule", "scopeKind": "function"}, {"_type": "tag", "name": "writeActivity", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/automation-enforcer/index.ts", "pattern": "/^async function writeActivity(url: string, key: string, userId: string, row: Record<string, unkno/", "language": "TypeScript", "kind": "function"}], "hash": "5c26501f9e5edd53eea0a3c4bba53e14", "format-version": 4, "code-base-name": "react_frontend_dashboard", "filename": "supabase/functions/automation-enforcer/index.ts", "fields": [{"name": "let queued = 0;", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "let totalQueued = 0;", "scope": "", "scopeKind": "", "description": "unavailable"}], "revision_history": [{"188": ""}]}