{"is_source_file": true, "format": "TypeScript", "description": "This file defines an HTTP serverless function (edge function) that handles linking cloud provider accounts (AWS, Azure, GCP) to a user in a system. It validates authentication via JWT, processes input payloads, stores minimal metadata and sensitive credentials securely in a database via REST API calls to Supabase, and logs activity. The code includes safeguards, parsing, masking functions, and helper methods for responses.", "external_files": ["https://deno.land/std/http/server.ts"], "external_methods": ["serve", "jsonResponse", "postgrestInsert", "getUserIdFromJwt", "padBase64", "maskKey", "maskId"], "published": [], "classes": [], "methods": [{"name": "function jsonResponse(body: unknown, status = 200) { jsonResponse", "description": "Constructs an HTTP Response with JSON content and specified status code.", "scope": "", "scopeKind": ""}, {"name": "function postgrestInsert(url: string, key: string, row: Record<string, unknown>) { postgrestInsert", "description": "Performs a POST request to a specified URL with given headers and body, returning the fetch Response object.", "scope": "", "scopeKind": ""}, {"name": "function getUserIdFromJwt(token: string): string | null { getUserIdFromJwt", "description": "Extracts the 'sub' claim (user ID) from a JWT token without verifying signature.", "scope": "", "scopeKind": ""}, {"name": "function padBase64(base64: string) { padBase64", "description": "Pads Base64 URL-safe strings to proper length for decoding.", "scope": "", "scopeKind": ""}, {"name": "function maskKey(k: string) { maskKey", "description": "Simple masking of keys for obfuscation, truncates string to mask sensitive data.", "scope": "", "scopeKind": ""}, {"name": "function maskId(id: string) { maskId", "description": "Simple masking of IDs for obfuscation, truncates string with placeholders.", "scope": "", "scopeKind": ""}], "calls": ["serve", "jsonResponse", "postgrestInsert", "getUserIdFromJwt", "padBase64", "maskKey", "maskId", "fetch"], "search-terms": ["link-account", "cloud provider account linking", "Supabase JWT authentication", "AWS credentials", "Azure credentials", "GCP service account JSON", "cloud_accounts", "cloud_credentials", "activity_log", "edge function"], "state": 2, "file_id": 57, "knowledge_revision": 174, "git_revision": "", "ctags": [{"_type": "tag", "name": "access_key_id", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^      const { access_key_id, secret_access_key, account_id: awsAccountId } = payload || {};$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "account", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const account = Array.isArray(insertedAccounts) && insertedAccounts[0] ? insertedAccounts[0]/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "accountIdPk", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const accountIdPk = account?.id;$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "accountInsert", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const accountInsert = await postgrestInsert(`${supabaseUrl}\\/rest\\/v1\\/cloud_accounts`, admi/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "account_id", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^      const { access_key_id, secret_access_key, account_id: awsAccountId } = payload || {};$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "account_id", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    let account_id = \"\";$/", "language": "TypeScript", "kind": "variable"}, {"_type": "tag", "name": "adminKey", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const adminKey = serviceRole || supabaseAnonKey;$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "authHeader", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const authHeader = req.headers.get(\"Authorization\") || \"\";$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "client_id", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^      const { tenant_id, client_id, client_secret, subscription_id } = payload || {};$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "client_secret", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^      const { tenant_id, client_id, client_secret, subscription_id } = payload || {};$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "credsInsert", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const credsInsert = await postgrestInsert(`${supabaseUrl}\\/rest\\/v1\\/cloud_credentials`, adm/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "err", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^      const err = await accountInsert.text();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "err", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^      const err = await credsInsert.text();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "getUserIdFromJwt", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^function getUserIdFromJwt(token: string): string | null {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "insertedAccounts", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const insertedAccounts = await accountInsert.json().catch(() => []);$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "jsonResponse", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^function jsonResponse(body: unknown, status = 200) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "jwt", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const jwt = authHeader.startsWith(\"Bearer \") ? authHeader.slice(7) : null;$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "maskId", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^function maskId(id: string) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "maskKey", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^function maskKey(k: string) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "name", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const { provider, name } = payload || {};$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "now", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const now = new Date().toISOString();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "p", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const p = String(provider).toUpperCase();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "padBase64", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^function padBase64(base64: string) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "parts", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const parts = token.split(\".\");$/", "language": "TypeScript", "kind": "constant", "scope": "getUserIdFromJwt", "scopeKind": "function"}, {"_type": "tag", "name": "payload", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const payload = JSON.parse(atob(padBase64(parts[1])));$/", "language": "TypeScript", "kind": "constant", "scope": "getUserIdFromJwt", "scopeKind": "function"}, {"_type": "tag", "name": "payload", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const payload = await req.json().catch(() => ({}));$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "postgrestInsert", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^function postgrestInsert(url: string, key: string, row: Record<string, unknown>) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "provider", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const { provider, name } = payload || {};$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "s", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^  const s = String(id);$/", "language": "TypeScript", "kind": "constant", "scope": "maskId", "scopeKind": "function"}, {"_type": "tag", "name": "s", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^  const s = String(k);$/", "language": "TypeScript", "kind": "constant", "scope": "maskKey", "scopeKind": "function"}, {"_type": "tag", "name": "sa", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^      let sa: any;$/", "language": "TypeScript", "kind": "variable"}, {"_type": "tag", "name": "safeMetadata", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    let safeMetadata: Record<string, unknown> = {};$/", "language": "TypeScript", "kind": "variable"}, {"_type": "tag", "name": "secretPayload", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    let secretPayload: Record<string, unknown> = {};$/", "language": "TypeScript", "kind": "variable"}, {"_type": "tag", "name": "secret_access_key", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^      const { access_key_id, secret_access_key, account_id: awsAccountId } = payload || {};$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "serviceRole", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const serviceRole = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\"); \\/\\/ recommended for server-s/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "service_account_json", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^      const { service_account_json } = payload || {};$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "subscription_id", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^      const { tenant_id, client_id, client_secret, subscription_id } = payload || {};$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "supabaseAnonKey", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const supabaseAnonKey = Deno.env.get(\"SUPABASE_ANON_KEY\");$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "supabaseUrl", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\");$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "tenant_id", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^      const { tenant_id, client_id, client_secret, subscription_id } = payload || {};$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "userId", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/link-account/index.ts", "pattern": "/^    const userId = getUserIdFromJwt(jwt);$/", "language": "TypeScript", "kind": "constant"}], "hash": "dda7f8c46f9138f8983f47d3d573b701", "format-version": 4, "code-base-name": "react_frontend_dashboard", "filename": "supabase/functions/link-account/index.ts", "fields": [{"name": "let account_id = \"\";", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "let sa: any;", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "let safeMetadata: Record<string, unknown> = {};", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "let secretPayload: Record<string, unknown> = {};", "scope": "", "scopeKind": "", "description": "unavailable"}], "revision_history": [{"174": ""}]}