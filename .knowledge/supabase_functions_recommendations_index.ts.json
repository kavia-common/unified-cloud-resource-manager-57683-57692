{"is_source_file": true, "format": "TypeScript", "description": "This file implements a serverless Edge Function that provides recommendations related to resource optimization, including idle detection, rightsizing, and anomaly detection. It handles HTTP POST requests at the /run route, authenticates users via JWT, fetches user resources and costs from a database, analyzes data using heuristics, and inserts suggestions into a recommendations table. It also logs activity for each execution.", "external_files": ["https://deno.land/std/http/server.ts"], "external_methods": ["serve", "json", "apiHeaders", "getUserIdFromJwt", "padB64", "round2"], "published": ["serve"], "classes": [], "methods": [{"name": "function json(body: unknown, status = 200) { json", "description": "Helper function to create a JSON HTTP response with given body and status.", "scope": "", "scopeKind": ""}, {"name": "function apiHeaders(key: string) { apiHeaders", "description": "Generates headers including API key and authorization token for API requests.", "scope": "", "scopeKind": ""}, {"name": "function getUserIdFromJwt(token: string): string | null { getUserIdFromJwt", "description": "Decodes a JWT token to extract the user ID (sub claim).", "scope": "", "scopeKind": ""}, {"name": "function padB64(b: string) { padB64", "description": "Pads base64 string to proper length for decoding.", "scope": "", "scopeKind": ""}, {"name": "function round2(n: number) { round2", "description": "Rounds a number to two decimal places.", "scope": "", "scopeKind": ""}], "calls": ["json", "apiHeaders", "getUserIdFromJwt", "fetch", "Object.keys", "Array.isArray", "Number", "String", "Math.round"], "search-terms": ["recommendations", "Edge Function", "resource optimization", "idle resource detection", "rightsizing", "anomaly detection", "public.recommendations", "public.activity_log", "authorization", "/run route"], "state": 2, "file_id": 62, "knowledge_revision": 186, "git_revision": "", "ctags": [{"_type": "tag", "name": "SERVICE_KEY", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const SERVICE_KEY = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\") || Deno.env.get(\"SUPABASE_ANON/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "SUPABASE_URL", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const SUPABASE_URL = Deno.env.get(\"SUPABASE_URL\");$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "apiHeaders", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^function apiHeaders(key: string) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "authHeader", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const authHeader = req.headers.get(\"Authorization\") || \"\";$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "batchResp", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^      const batchResp = await fetch(`${SUPABASE_URL}\\/rest\\/v1\\/recommendations`, {$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "body", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const body = await req.json().catch(() => ({}));$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "costsCur", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const costsCur = costsCurResp.ok ? await costsCurResp.json() : [];$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "costsCurResp", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const costsCurResp = await fetch($/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "costsPrev", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const costsPrev = costsPrevResp.ok ? await costsPrevResp.json() : [];$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "costsPrevResp", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const costsPrevResp = await fetch($/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "cur", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^        const cur = curMap[svc] || 0;$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "curMap", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^      const curMap = sumByService(costsCur);$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "daily", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^        const daily = Number(r?.cost_daily || 0);$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "getUserIdFromJwt", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^function getUserIdFromJwt(token: string): string | null {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "impactMonthly", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^          const impactMonthly = Number(r?.cost_monthly || (daily * 30)) * 0.35; \\/\\/ assume 35% /", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "impactMonthly", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^          const impactMonthly = Number(r?.cost_monthly || (daily * 30)) * 0.6; \\/\\/ assume we ca/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "impactMonthly", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^          const impactMonthly = cur - prev;$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "inserted", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    let inserted = 0;$/", "language": "TypeScript", "kind": "variable"}, {"_type": "tag", "name": "json", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^function json(body: unknown, status = 200) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "jwt", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const jwt = authHeader.startsWith(\"Bearer \") ? authHeader.slice(7) : null;$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "modes", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const modes = Array.isArray(body?.modes) && body.modes.length ? body.modes : [\"idle\", \"right/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "month", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const month = new Date();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "monthStr", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const monthStr = month.toISOString().slice(0, 10);$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "now", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const now = new Date().toISOString();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "out", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^      const out = await batchResp.json();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "padB64", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^function padB64(b: string) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "parts", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const parts = token.split(\".\");$/", "language": "TypeScript", "kind": "constant", "scope": "getUserIdFromJwt", "scopeKind": "function"}, {"_type": "tag", "name": "payload", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const payload = JSON.parse(atob(padB64(parts[1])));$/", "language": "TypeScript", "kind": "constant", "scope": "getUserIdFromJwt", "scopeKind": "function"}, {"_type": "tag", "name": "prev", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^          const impactMonthly = cur - prev;$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "prev", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^        const prev = prevMap[svc] || 0;$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "prevMap", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^      const prevMap = sumByService(costsPrev);$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "prevMonth", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const prevMonth = new Date(month);$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "prevMonthStr", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const prevMonthStr = prevMonth.toISOString().slice(0, 10);$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "r", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^      for (const r of resources) {$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "recsToInsert", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const recsToInsert: any[] = [];$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "resResp", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const resResp = await fetch(`${SUPABASE_URL}\\/rest\\/v1\\/resources?user_id=eq.${userId}&selec/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "resources", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const resources: any[] = await resResp.json();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "round2", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^function round2(n: number) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "size", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^        const size = String(r?.metadata?.size || r?.tags?.size || \"\").toLowerCase();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "state", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^        const state = String(r?.state || \"\");$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "sumByService", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^      const sumByService = (rows: any[]) => {$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "svc", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^        const cur = curMap[svc] || 0;$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "svc", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^        const prev = prevMap[svc] || 0;$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "svc", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^      for (const svc of Object.keys(curMap)) {$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "t", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^        const t = await batchResp.text();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "t", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^      const t = await resResp.text();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "type", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^        const type = String(r?.type || \"\").toLowerCase();$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "url", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const url = new URL(req.url);$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "userId", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^    const userId = getUserIdFromJwt(jwt || \"\");$/", "language": "TypeScript", "kind": "constant"}, {"_type": "tag", "name": "utilHint", "path": "/home/kavia/workspace/code-generation/unified-cloud-resource-manager-57683-57692/supabase/functions/recommendations/index.ts", "pattern": "/^        const utilHint = Number(r?.metadata?.utilization || r?.metadata?.cpu_utilization || 0);$/", "language": "TypeScript", "kind": "constant"}], "hash": "96a5e45ae0125bd58966a35599ca045e", "format-version": 4, "code-base-name": "react_frontend_dashboard", "filename": "supabase/functions/recommendations/index.ts", "fields": [{"name": "let inserted = 0;", "scope": "", "scopeKind": "", "description": "unavailable"}], "revision_history": [{"186": ""}]}